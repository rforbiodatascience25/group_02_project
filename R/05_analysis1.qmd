---
title: "05_analysis1"
format: html
embed-resources: true
---

### Libraries

```{r}
#| message: false

library("tidyverse")
library("here")
library("broom")
library("patchwork")
library("ggridges")

Sys.setenv("VROOM_CONNECTION_SIZE" = 131072 * 2)
```

### PCA

```{r}
#| message: false
analysis_data <- read_tsv(here("data", "03_expression_dat_aug.tsv.gz"))
```

```{r}
pca <- analysis_data |> 
  select(starts_with("ILMN_")) |> 
  scale() |> 
  prcomp()
```

#### Variance explained by principal components

```{r}
pca_var <- pca |> 
  tidy("eigenvalues")

p1 <- pca_var |> 
  ggplot(aes(PC, percent)) +
  geom_col()
  
p2 <- pca_var |> 
  ggplot(aes(PC, cumulative)) +
  geom_line() +
  geom_point()

p1 + p2
```

#### Data in principal component coordinates

```{r}
pca |> 
  augment(analysis_data) |> 
  pivot_longer(cols = starts_with(".fitted"),
               names_to = "PC",
               values_to = "value") |> 
  mutate(PC = as.numeric(str_extract(PC,
                                     "[0-9]+"))) |> 
  filter(PC < 6) |> 
  mutate(PC = as.character(PC)) |> 
  ggplot(aes(x = value, y = PC, fill = Response_group)) +
  geom_density_ridges(alpha = 0.5)
```

```{r}
pca |> 
  augment(analysis_data) |> 
  ggplot(aes(.fittedPC2, .fittedPC3, color = Response_group)) +
  geom_point()
```
